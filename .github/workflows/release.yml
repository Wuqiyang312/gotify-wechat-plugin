name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  detect-go-version:
    runs-on: ubuntu-latest
    outputs:
      go-version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Fetch gotify/server GO_VERSION
        id: get-version
        run: |
          # 获取与 gotify/server 最新 release 一致的 Go 版本
          SERVER_VERSION=$(curl -sL https://api.github.com/repos/gotify/server/releases/latest | jq -r '.tag_name')
          GO_VERSION=$(curl -sL "https://raw.githubusercontent.com/gotify/server/${SERVER_VERSION}/GO_VERSION" | tr -d '\n\r ')
          if [ -z "$GO_VERSION" ]; then
            echo "::error::Failed to fetch GO_VERSION"
            exit 1
          fi
          echo "version=$GO_VERSION" >> $GITHUB_OUTPUT
          echo "Gotify Server: $SERVER_VERSION, Go: $GO_VERSION"

  build:
    needs: detect-go-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - arch: amd64
            build-image-suffix: linux-amd64
          - arch: arm64
            build-image-suffix: linux-arm64
          - arch: arm-7
            build-image-suffix: linux-arm-7
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 在宿主机(amd64)上用 Go 运行 gomod-cap 对齐依赖，避免交叉编译镜像中 exec format error
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ needs.detect-go-version.outputs.go-version }}

      - name: Align dependencies with gotify/server
        run: |
          SERVER_VERSION=$(curl -sL https://api.github.com/repos/gotify/server/releases/latest | jq -r '.tag_name')
          echo "Aligning dependencies with gotify/server ${SERVER_VERSION}"
          curl -sL "https://raw.githubusercontent.com/gotify/server/${SERVER_VERSION}/go.mod" -o /tmp/gotify-server-go.mod
          go run github.com/gotify/plugin-api/cmd/gomod-cap@latest -from /tmp/gotify-server-go.mod -to go.mod
          go mod tidy

      # 使用 gotify/build 交叉编译镜像构建插件
      - name: Build plugin
        run: |
          mkdir -p build
          docker run --rm \
            -v "$PWD:/proj" \
            -w /proj \
            gotify/build:${{ needs.detect-go-version.outputs.go-version }}-${{ matrix.build-image-suffix }} \
            go build -a -installsuffix cgo -ldflags '-w -s' \
              -buildmode=plugin \
              -o build/gotify-wechat-plugin-linux-${{ matrix.arch }}.so .

      - name: Verify plugin
        run: file build/*.so

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-${{ matrix.arch }}
          path: build/*.so

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: build
          pattern: plugin-*
          merge-multiple: true

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.so
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
