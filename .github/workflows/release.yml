name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  detect-go-version:
    runs-on: ubuntu-latest
    outputs:
      go-version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Fetch gotify/server GO_VERSION
        id: get-version
        run: |
          # 获取与 gotify/server 最新 release 一致的 Go 版本
          SERVER_VERSION=$(curl -sL https://api.github.com/repos/gotify/server/releases/latest | jq -r '.tag_name')
          GO_VERSION=$(curl -sL "https://raw.githubusercontent.com/gotify/server/${SERVER_VERSION}/GO_VERSION" | tr -d '\n\r ')
          if [ -z "$GO_VERSION" ]; then
            echo "::error::Failed to fetch GO_VERSION"
            exit 1
          fi
          echo "version=$GO_VERSION" >> $GITHUB_OUTPUT
          echo "Gotify Server: $SERVER_VERSION, Go: $GO_VERSION"

  build:
    needs: detect-go-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - arch: amd64
            build-image-suffix: linux-amd64
          - arch: arm64
            build-image-suffix: linux-arm64
          - arch: arm-7
            build-image-suffix: linux-arm-7
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 使用 gomod-cap 对齐插件依赖版本与 gotify/server 完全一致，然后构建
      - name: Align dependencies and build plugin
        run: |
          SERVER_VERSION=$(curl -sL https://api.github.com/repos/gotify/server/releases/latest | jq -r '.tag_name')
          echo "Aligning dependencies with gotify/server ${SERVER_VERSION}"
          curl -sL "https://raw.githubusercontent.com/gotify/server/${SERVER_VERSION}/go.mod" -o /tmp/gotify-server-go.mod
          mkdir -p build
          docker run --rm \
            -v "$PWD:/proj" \
            -v "/tmp/gotify-server-go.mod:/tmp/gotify-server-go.mod" \
            -w /proj \
            gotify/build:${{ needs.detect-go-version.outputs.go-version }}-${{ matrix.build-image-suffix }} \
            sh -c "go install github.com/gotify/plugin-api/cmd/gomod-cap@latest && \
                   gomod-cap -from /tmp/gotify-server-go.mod -to go.mod && \
                   go mod tidy && \
                   go build -a -installsuffix cgo -ldflags '-w -s' \
                     -buildmode=plugin \
                     -o build/gotify-wechat-plugin-linux-${{ matrix.arch }}.so ."

      - name: Verify plugin
        run: file build/*.so

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-${{ matrix.arch }}
          path: build/*.so

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: build
          pattern: plugin-*
          merge-multiple: true

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.so
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
